<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Problemes de Tecnologia i Enginyeria</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
    <script src="questions.js" defer></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .ocult { display: none; }
        .visible { display: block; }
        .question-images { margin: 10px 0; }
        #load-time { margin: 20px; font-style: italic; color: #555; font-size: 0.8rem; }
    </style>
</head>
<body>

<header class="navbar-header" style="position: fixed; top: 0; left: 0; width: 100%; background: var(--bg-card); border-bottom: 1px solid var(--border); z-index: 1000; padding: 15px 0;">
    <div style="max-width: 900px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;">
        <h2 style="margin: 0; font-size: 1.2rem;">Problemes de Tecnologia</h2>
        <span id="dark-toggle" style="cursor:pointer; font-size: 1.5rem;">üåô</span>
    </div>
</header>

<div class="filter-group-container" style="margin-top: 100px;">
    <label>Tipus de preguntes:</label>
    <div id="type-filter-buttons" class="filter-group">
        <button class="filter-button active" data-filter="totes" onclick="selectFilter(this, 'type')">Totes</button>
        <button class="filter-button" data-filter="questions" onclick="selectFilter(this, 'type')">Q√ºestions</button>
        <button class="filter-button" data-filter="exercicis" onclick="selectFilter(this, 'type')">Exercicis</button>
    </div>

    <label>Tria una categoria:</label>
    <div id="category-filter-buttons" class="filter-group">
        <button class="filter-button active" data-filter="tot" onclick="selectFilter(this, 'category')">Tot</button>
        <button class="filter-button" data-filter="energia" onclick="selectFilter(this, 'category')">Energia</button>
        <button class="filter-button" data-filter="materials" onclick="selectFilter(this, 'category')">Materials i assaigs</button>
        <button class="filter-button" data-filter="metrologia" onclick="selectFilter(this, 'category')">Metrologia</button>
        <button class="filter-button" data-filter="pneumatica" onclick="selectFilter(this, 'category')">Pneum√†tica</button>
        <button class="filter-button" data-filter="motors" onclick="selectFilter(this, 'category')">Motors</button>
        <button class="filter-button" data-filter="control" onclick="selectFilter(this, 'category')">Control</button>
    </div>
</div>

<div id="quiz-container"></div>
<div id="load-time"></div>

<script>
/* ----------------- Log de c√†rrega ----------------- */
let domReadyTime = 0;
document.addEventListener("DOMContentLoaded", () => { domReadyTime = (performance.now()).toFixed(2); });
window.addEventListener('load', () => {
    const loadDiv = document.getElementById("load-time");
    if(loadDiv) loadDiv.innerHTML = `P√†gina carregada en ${performance.now().toFixed(2)} ms`;
});

/* ----------------- Mode fosc ----------------- */
const toggle = document.getElementById("dark-toggle");
toggle.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    toggle.textContent = document.body.classList.contains("dark-mode") ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
});
if(localStorage.getItem("theme")==="dark") { document.body.classList.add("dark-mode"); toggle.textContent="‚òÄÔ∏è"; }

/* ----------------- L√≤gica de Filtres ----------------- */
let activeFilters = { type: 'totes', category: 'tot' };

function selectFilter(button, filterType) {
    button.parentElement.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    activeFilters[filterType] = button.getAttribute('data-filter');
    renderQuiz();
}

/* ----------------- Render i Funcions Auxiliars ----------------- */
function renderImages(q) {
    let html = '';
    if(q.images) html += `<div class="question-images">${q.images}</div>`;
    if(q.answerImage) html += `<img src="${q.answerImage}" style="max-width:100%; height:auto; margin-top:10px;">`;
    return html;
}

function generateOptions(options, idx, correctAnswer) {
    if(!options) return '';
    const correctOption = options.find(o => o.value.trim().toLowerCase() === correctAnswer.trim().toLowerCase());
    const correctText = correctOption ? correctOption.text : correctAnswer; 
    
    return `<ul>${options.map(o => `
        <li>
            <button onclick="checkAnswer('${o.value}','${correctAnswer}','answer${idx}','steps${idx}','result${idx}', '${correctText.replace(/'/g, "\\'")}', this)">
                ${o.text}
            </button>
        </li>`).join('')}</ul>`;
}

function renderQuiz() {
    const container = document.getElementById("quiz-container");
    container.innerHTML = '';

    const filtered = questions.map((q,i)=>({...q, originalIndex:i}))
        .filter(q => (activeFilters.category==='tot' || q.category===activeFilters.category)
                  && (activeFilters.type==='totes' || q.type===activeFilters.type));

    filtered.forEach(q => {
        const div = document.createElement("div");
        div.className = 'quiz-item';
        div.innerHTML = `
            <h3>${q.typeText} ${q.globalNumber}</h3>
            <div class="question-text">${q.text}</div>
            ${renderImages(q)}
            ${generateOptions(q.options, q.originalIndex, q.correctAnswer)}
            <div id="result${q.originalIndex}" class="result-box ocult">
                <div id="answer${q.originalIndex}" class="feedback-container"></div>
                <p><strong>Soluci√≥ pas a pas:</strong></p>
                <div id="steps${q.originalIndex}">${q.steps || ''}</div>
            </div>
            ${q.type==='exercicis' ? `<button class="solution-button" onclick="toggleSolution(${q.originalIndex},this)">Mostra soluci√≥</button>` : ''}
        `;
        container.appendChild(div);
    });
    MathJax.typesetPromise();
}

/* ----------------- FUNCIONS CLAU CORREGIDES ----------------- */
function checkAnswer(selected, correct, answerId, stepsId, resultId, correctText, buttonElement) {
    const a = document.getElementById(answerId);
    const r = document.getElementById(resultId);

    // 1. Netejar seleccions anteriors
    const ul = buttonElement.closest('ul');
    ul.querySelectorAll('button').forEach(btn => {
        btn.classList.remove('selected', 'selected-correct', 'selected-incorrect');
    });

    // 2. Comprovar resposta
    const isCorrect = selected.trim().toLowerCase() === correct.trim().toLowerCase();

    // 3. Feedback visual
    if (isCorrect) {
        buttonElement.classList.add('selected-correct');
        a.innerHTML = `<div class="correcta">‚úÖ Correcte! Has seleccionat la resposta correcta.</div>`;
    } else {
        buttonElement.classList.add('selected-incorrect');
        a.innerHTML = `<div class="incorrecta">‚ùå Incorrecte. La resposta correcta √©s: ${correctText}.</div>`;
    }
        
    // 4. Mostrar resultats i soluci√≥
    r.classList.add('visible');
    r.classList.remove('ocult');
    
    // Si √©s exercici, actualitzem el bot√≥ de sota
    const solBtn = r.nextElementSibling;
    if(solBtn && solBtn.classList.contains('solution-button')) solBtn.textContent = 'Amaga soluci√≥';

    MathJax.typesetPromise();
}

function toggleSolution(idx, btn) {
    const r = document.getElementById(`result${idx}`);
    if(r.classList.contains('visible')) {
        r.classList.replace('visible','ocult');
        btn.textContent = 'Mostra soluci√≥';
    } else {
        r.classList.replace('ocult','visible');
        btn.textContent = 'Amaga soluci√≥';
    }
    MathJax.typesetPromise();
}

function calculateGlobalNumbers() {
    let qCount = 1, eCount = 1;
    if (typeof questions === 'undefined') return;
    questions.forEach(q => {
        if (q.type === 'questions') { q.globalNumber = qCount++; q.typeText = 'Q√ºesti√≥'; }
        else { q.globalNumber = eCount++; q.typeText = 'Exercici'; }
    });
}

function initializeQuiz() {
    calculateGlobalNumbers();
    renderQuiz();
}

document.addEventListener("DOMContentLoaded", initializeQuiz);
</script>
</body>
</html>
