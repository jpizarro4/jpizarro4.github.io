<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Problemes de Tecnologia i Enginyeria</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
    <script src="questions.js" defer></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* RESET DE SEGURETAT PER EVITAR DOBLE LINIA */
        h2 { display: none; } /* Amaguem qualsevol h2 que vingui de styles.css */
        
        .ocult { display: none; }
        .visible { display: block; }

        /* NAVBAR UNIFICADA */
        .header-fix {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            border-bottom: 1px solid #333;
        }

        .header-content {
            width: 100%;
            max-width: 1000px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 0;
        }

        #dark-toggle {
            font-size: 1.5rem;
            cursor: pointer;
            user-select: none;
            padding: 5px;
        }

        /* AJUST DE COS PER NO QUEDAR TAPAT */
        body { padding-top: 90px; }

        /* Estil per a les categories perqu√® no s'amunteguin */
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<header class="header-fix">
    <div class="header-content">
        <p class="header-title">Tecnologia i Enginyeria</p>
        <span id="dark-toggle">üåô</span>
    </div>
</header>

<div class="filter-group-container">
    <div style="margin-bottom: 10px; font-weight: bold;">Tipus:</div>
    <div id="type-filter-buttons" class="filter-group">
        <button class="filter-button active" data-filter="totes" onclick="selectFilter(this, 'type')">Totes</button>
        <button class="filter-button" data-filter="questions" onclick="selectFilter(this, 'type')">Q√ºestions</button>
        <button class="filter-button" data-filter="exercicis" onclick="selectFilter(this, 'type')">Exercicis</button>
    </div>

    <div style="margin-bottom: 10px; font-weight: bold;">Categories:</div>
    <div id="category-filter-buttons" class="filter-group">
        <button class="filter-button active" data-filter="tot" onclick="selectFilter(this, 'category')">Tot</button>
        <button class="filter-button" data-filter="energia" onclick="selectFilter(this, 'category')">Energia</button>
        <button class="filter-button" data-filter="materials" onclick="selectFilter(this, 'category')">Materials i assaigs</button>
        <button class="filter-button" data-filter="metrologia" onclick="selectFilter(this, 'category')">Metrologia i normalitzaci√≥</button>
        <button class="filter-button" data-filter="pneumatica" onclick="selectFilter(this, 'category')">Sistemes pneum√†tics i oleohidr√†ulics</button>
        <button class="filter-button" data-filter="motors" onclick="selectFilter(this, 'category')">Motors reductors</button>
        <button class="filter-button" data-filter="maquines" onclick="selectFilter(this, 'category')">Principis de les m√†quines</button>
        <button class="filter-button" data-filter="electrics" onclick="selectFilter(this, 'category')">M√†quines i sistemes el√®ctrics</button>
        <button class="filter-button" data-filter="control" onclick="selectFilter(this, 'category')">Control l√≤gic i funcions l√≤giques</button>
        <button class="filter-button" data-filter="organitzacio" onclick="selectFilter(this, 'category')">Organitzaci√≥ industrial</button>
    </div>
</div>

<div id="quiz-container"></div>

<script>
/* ----------------- Mode fosc ----------------- */
const toggle = document.getElementById("dark-toggle");
const body = document.body;

toggle.addEventListener("click", () => {
    body.classList.toggle("dark-mode");
    const isDark = body.classList.contains("dark-mode");
    toggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("theme", isDark ? "dark" : "light");
});

if(localStorage.getItem("theme") === "dark") {
    body.classList.add("dark-mode");
    toggle.textContent = "‚òÄÔ∏è";
}

/* ----------------- Filtres i Render ----------------- */
let activeFilters = { type: 'totes', category: 'tot' };

function selectFilter(button, filterType) {
    button.parentElement.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    activeFilters[filterType] = button.getAttribute('data-filter');
    renderQuiz();
}

function renderQuiz() {
    const container = document.getElementById("quiz-container");
    container.innerHTML = '';

    const filtered = questions.map((q, i) => ({...q, originalIndex: i}))
        .filter(q => (activeFilters.category === 'tot' || q.category === activeFilters.category)
                  && (activeFilters.type === 'totes' || q.type === activeFilters.type));

    filtered.forEach(q => {
        const div = document.createElement("div");
        div.className = 'quiz-item';
        div.innerHTML = `
            <h3>${q.typeText} ${q.globalNumber}</h3>
            <div class="question-text">${q.text}</div>
            ${q.images ? `<div class="question-images">${q.images}</div>` : ''}
            ${generateOptions(q.options, q.originalIndex, q.correctAnswer)}
            <div id="result${q.originalIndex}" class="result-box ocult">
                <div id="answer${q.originalIndex}" class="feedback-container"></div>
                <p><strong>Soluci√≥ pas a pas:</strong></p>
                <div id="steps${q.originalIndex}">${q.steps || ''}</div>
            </div>
            ${q.type === 'exercicis' ? `<button class="solution-button" onclick="toggleSolution(${q.originalIndex},this)">Mostra soluci√≥</button>` : ''}
        `;
        container.appendChild(div);
    });
    MathJax.typesetPromise();
}

function generateOptions(options, idx, correctAnswer) {
    if(!options) return '';
    const correctOption = options.find(o => o.value.trim().toLowerCase() === correctAnswer.trim().toLowerCase());
    const correctText = correctOption ? correctOption.text : correctAnswer; 
    
    return `<ul>${options.map(o => `
        <li>
            <button onclick="checkAnswer('${o.value}','${correctAnswer}','answer${idx}','steps${idx}','result${idx}', '${correctText.replace(/'/g, "\\'")}', this)">
                ${o.text}
            </button>
        </li>`).join('')}</ul>`;
}

function checkAnswer(selected, correct, answerId, stepsId, resultId, correctText, buttonElement) {
    const a = document.getElementById(answerId);
    const r = document.getElementById(resultId);
    const ul = buttonElement.closest('ul');
    
    ul.querySelectorAll('button').forEach(btn => btn.classList.remove('selected', 'selected-correct', 'selected-incorrect'));

    const isCorrect = selected.trim().toLowerCase() === correct.trim().toLowerCase();
    if (isCorrect) {
        buttonElement.classList.add('selected-correct');
        a.innerHTML = `<div class="correcta">‚úÖ Correcte!</div>`;
    } else {
        buttonElement.classList.add('selected-incorrect');
        a.innerHTML = `<div class="incorrecta">‚ùå Incorrecte. La resposta √©s: ${correctText}</div>`;
    }
    r.classList.add('visible');
    r.classList.remove('ocult');
    MathJax.typesetPromise();
}

function toggleSolution(idx, btn) {
    const r = document.getElementById(`result${idx}`);
    const isVisible = r.classList.contains('visible');
    r.classList.toggle('visible', !isVisible);
    r.classList.toggle('ocult', isVisible);
    btn.textContent = isVisible ? 'Mostra soluci√≥' : 'Amaga soluci√≥';
    MathJax.typesetPromise();
}

function initializeQuiz() {
    if (typeof questions === 'undefined') return;
    let qCount = 1, eCount = 1;
    questions.forEach(q => {
        if (q.type === 'questions') { q.globalNumber = qCount++; q.typeText = 'Q√ºesti√≥'; }
        else { q.globalNumber = eCount++; q.typeText = 'Exercici'; }
    });
    renderQuiz();
}

document.addEventListener("DOMContentLoaded", initializeQuiz);
</script>
</body>
</html>
